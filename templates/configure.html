<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Cloud - Konfigürasyon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            transition: transform 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }

        .config-section {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-bottom: 30px;
        }

        .ocid-help {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .tab-pane {
            padding: 20px 0;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        textarea {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <!-- Başlık ve Navigasyon -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="text-white mb-0">
                            <i class="fas fa-cogs me-2"></i>Oracle Cloud Konfigürasyon
                        </h1>
                        <p class="text-white-50 mb-0">Tüm gerekli bilgileri aşağıdaki formlara girin</p>
                    </div>
                    <div>
                        <a href="/" class="btn btn-outline-light me-2">
                            <i class="fas fa-home me-1"></i>Ana Sayfa
                        </a>
                        <a href="/status" class="btn btn-outline-light">
                            <i class="fas fa-chart-bar me-1"></i>Durum
                        </a>
                    </div>
                </div>

                <!-- Sekmeler -->
                <div class="card">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="auth-tab" data-bs-toggle="tab"
                                    data-bs-target="#auth" type="button" role="tab">
                                    <i class="fas fa-key me-2"></i>1. OCI Kimlik Doğrulama
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="instance-tab" data-bs-toggle="tab"
                                    data-bs-target="#instance" type="button" role="tab">
                                    <i class="fas fa-server me-2"></i>2. Instance Ayarları
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network"
                                    type="button" role="tab">
                                    <i class="fas fa-network-wired me-2"></i>3. Ağ Ayarları
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ssh-tab" data-bs-toggle="tab" data-bs-target="#ssh"
                                    type="button" role="tab">
                                    <i class="fas fa-terminal me-2"></i>4. SSH Anahtarı
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab"
                                    data-bs-target="#advanced" type="button" role="tab">
                                    <i class="fas fa-sliders-h me-2"></i>5. Gelişmiş Ayarlar
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="configTabsContent">
                            <!-- Sekme 1: OCI Kimlik Doğrulama -->
                            <div class="tab-pane fade show active" id="auth" role="tabpanel">
                                <div class="config-section">
                                    <h4><i class="fas fa-user-shield me-2"></i>OCI Kimlik Bilgileri</h4>
                                    <p class="text-muted">Oracle Cloud hesabınızdan alacağınız bilgiler</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">User OCID *</label>
                                        <input type="text" class="form-control" id="user_ocid"
                                            placeholder="ocid1.user.oc1..aaaaaaa...">
                                        <div class="ocid-help">
                                            OCI Console → User Settings → User Information
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tenancy OCID *</label>
                                        <input type="text" class="form-control" id="tenancy_ocid"
                                            placeholder="ocid1.tenancy.oc1..aaaaaaa...">
                                        <div class="ocid-help">
                                            OCI Console → Administration → Tenancy Details
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Fingerprint *</label>
                                        <input type="text" class="form-control" id="fingerprint"
                                            placeholder="12:34:56:78:90:ab:cd:ef:12:34:56:78:90:ab:cd:ef">
                                        <div class="ocid-help">
                                            API Key oluştururken alınan fingerprint
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Region *</label>
                                        <select class="form-select" id="region">
                                            <option value="us-ashburn-1">US East (Ashburn)</option>
                                            <option value="us-phoenix-1">US West (Phoenix)</option>
                                            <option value="eu-frankfurt-1">Germany Central (Frankfurt)</option>
                                            <option value="uk-london-1">UK South (London)</option>
                                            <option value="ca-toronto-1">Canada Southeast (Toronto)</option>
                                            <option value="ap-sydney-1">Australia East (Sydney)</option>
                                            <option value="ap-mumbai-1">India West (Mumbai)</option>
                                            <option value="ap-tokyo-1">Japan East (Tokyo)</option>
                                            <option value="ap-seoul-1">South Korea Central (Seoul)</option>
                                            <option value="sa-saopaulo-1">Brazil East (São Paulo)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Private Key *</label>
                                    <textarea class="form-control" id="private_key" rows="8" placeholder="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7VJTUt9Us8cKj
MzEfYyjiWA4R4/M2bS1GBMZLJ1K5D...
-----END PRIVATE KEY-----"></textarea>
                                    <div class="ocid-help">
                                        API Key olarak oluşturduğunuz private key'in tamamı
                                    </div>
                                </div>
                            </div>

                            <!-- Sekme 2: Instance Ayarları -->
                            <div class="tab-pane fade" id="instance" role="tabpanel">
                                <div class="config-section">
                                    <h4><i class="fas fa-server me-2"></i>Instance Ayarları</h4>
                                    <p class="text-muted">Oluşturulacak instance için gerekli bilgiler</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Compartment OCID *</label>
                                        <input type="text" class="form-control" id="compartment_ocid"
                                            placeholder="ocid1.compartment.oc1..aaaaaaa...">
                                        <div class="ocid-help">
                                            OCI Console → Identity → Compartments
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Instance Adı</label>
                                        <input type="text" class="form-control" id="instance_name"
                                            value="free-tier-instance" placeholder="free-tier-instance">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Image OCID *</label>
                                        <input type="text" class="form-control" id="image_ocid"
                                            placeholder="ocid1.image.oc1..aaaaaaa...">
                                        <div class="ocid-help">
                                            İşletim sisteminizin Image OCID'sini girin
                                        </div>
                                        <div id="image_help" class="mt-2">
                                            <small class="text-muted">
                                                <strong>Image OCID Nasıl Bulunur?</strong><br>
                                                OCI Console → Compute → Images<br>
                                                Veya Marketplace'ten istediğiniz işletim sistemini seçin
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Shape (Instance Tipi) *</label>
                                        <select class="form-select" id="shape">
                                            <option value="VM.Standard.E2.1.Micro">VM.Standard.E2.1.Micro (1 OCPU, 1 GB
                                                RAM - Always Free)</option>
                                            <option value="VM.Standard.A1.Flex">VM.Standard.A1.Flex (1-4 OCPU, 6-24 GB
                                                RAM - Always Free Monthly Limit)</option>
                                        </select>
                                    </div>

                                    <!-- CPU/RAM Selection (A1.Flex için) -->
                                    <div class="col-md-6 mb-3" id="cpu_ram_container" style="display: none;">
                                        <label class="form-label">CPU ve RAM Seçimi *</label>
                                        <select class="form-select" id="cpu_ram">
                                            <option value="1_6">1 OCPU / 6 GB RAM</option>
                                            <option value="2_12">2 OCPU / 12 GB RAM</option>
                                            <option value="3_18">3 OCPU / 18 GB RAM</option>
                                            <option value="4_24" selected>4 OCPU / 24 GB RAM (Varsayılan)</option>
                                        </select>
                                        <div class="ocid-help">
                                            VM.Standard.A1.Flex için: Her 1 OCPU için 6 GB RAM otomatik atanır
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden fields for CPU/RAM values -->
                                <input type="hidden" id="ocpus" value="1">
                                <input type="hidden" id="memory_gb" value="1">

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Always Free Tier Bilgileri:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>VM.Standard.E2.1.Micro:</strong> 1 OCPU, 1 GB RAM - Her zaman
                                            ücretsiz</li>
                                        <li><strong>VM.Standard.A1.Flex:</strong> Toplam 4 OCPU ve 24 GB RAM - Aylık
                                            ücretsiz limit (istediğiniz kombinasyonu seçebilirsiniz)</li>
                                        <li>A1.Flex instance'larında OCPU ve RAM oranı 1:6'dır (1 OCPU = 6 GB RAM)</li>
                                        <li>Oracle Linux ve Ubuntu en popüler Always Free seçenekleridir</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Sekme 3: Ağ Ayarları -->
                            <div class="tab-pane fade" id="network" role="tabpanel">
                                <div class="config-section">
                                    <h4><i class="fas fa-network-wired me-2"></i>Ağ Ayarları</h4>
                                    <p class="text-muted">Instance'ın bağlanacağı ağ bilgileri</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Subnet OCID *</label>
                                        <input type="text" class="form-control" id="subnet_ocid"
                                            placeholder="ocid1.subnet.oc1..aaaaaaa...">
                                        <div class="ocid-help">
                                            Networking → Virtual Cloud Networks → Subnets
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Availability Domain *</label>
                                        <input type="text" class="form-control" id="availability_domain"
                                            placeholder="xxxx:US-ASHBURN-AD-1">
                                        <div class="ocid-help">
                                            OCI Console → Compute → Create Instance adımında görülür
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Önemli:</strong> Subnet'in public subnet olması gerekiyor.
                                    Security List'te SSH (port 22) trafiğine izin verildiğinden emin olun.
                                </div>
                            </div>

                            <!-- Sekme 4: SSH Anahtarı -->
                            <div class="tab-pane fade" id="ssh" role="tabpanel">
                                <div class="config-section">
                                    <h4><i class="fas fa-terminal me-2"></i>SSH Anahtar Yönetimi</h4>
                                    <p class="text-muted">Instance'a bağlanmak için SSH public key</p>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">SSH Public Key *</label>
                                    <textarea class="form-control" id="ssh_public_key" rows="6"
                                        placeholder="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7VJTUt9Us8cKj... user@host"></textarea>
                                    <div class="ocid-help">
                                        Örnek: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7VJTUt9Us8cKj... user@host
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6><i class="fas fa-question-circle me-2"></i>SSH Key Nasıl Oluşturulur?</h6>
                                    <p class="mb-2">Linux/Mac:</p>
                                    <pre
                                        class="bg-dark text-light p-2 rounded">ssh-keygen -t rsa -b 2048 -C "oracle-cloud"</pre>
                                    <p class="mb-2 mt-3">Windows (PowerShell):</p>
                                    <pre class="bg-dark text-light p-2 rounded">ssh-keygen -t rsa -b 2048</pre>
                                    <p class="mb-0 mt-2">Oluşan <code>id_rsa.pub</code> dosyasının içeriğini yukarıya
                                        yapıştırın.</p>
                                </div>
                            </div>

                            <!-- Sekme 5: Gelişmiş Ayarlar -->
                            <div class="tab-pane fade" id="advanced" role="tabpanel">
                                <div class="config-section">
                                    <h4><i class="fas fa-sliders-h me-2"></i>Gelişmiş Ayarlar</h4>
                                    <p class="text-muted">Otomatik deneme ayarları</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Maksimum Deneme Sayısı</label>
                                        <input type="number" class="form-control" id="max_attempts" value="50" min="1"
                                            max="1000">
                                        <div class="ocid-help">
                                            Kapasite bulunana kadar yapılacak maksimum deneme sayısı
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Deneme Aralığı (saniye)</label>
                                        <input type="number" class="form-control" id="retry_interval" value="300"
                                            min="60" max="3600">
                                        <div class="ocid-help">
                                            Her deneme arasında beklenecek saniye cinsinden süre
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Önerilen Ayarlar:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Yoğun saatlerde: 5-10 dakika (300-600 saniye)</li>
                                        <li>Gece saatlerinde: 1-2 dakika (60-120 saniye)</li>
                                        <li>Maksimum deneme: 24 saat boyunca denemek için ~288 (5 dakika aralıklarla)
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Doğrulama ve Başlatma -->
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-outline-secondary" id="validateBtn">
                                        <i class="fas fa-check-circle me-2"></i>Bilgileri Doğrula
                                    </button>
                                    <button class="btn btn-outline-info ms-2" id="saveConfigBtn">
                                        <i class="fas fa-save me-2"></i>Ayarları Kaydet
                                    </button>
                                </div>
                                <button class="btn btn-primary btn-lg" id="startTaskBtn" disabled>
                                    <i class="fas fa-play me-2"></i>Otomatik Denemeyi Başlat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Task Başlatılıyor -->
    <div class="modal fade" id="startingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Otomatik Deneme Başlatılıyor</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p>Task başlatılıyor, lütfen bekleyin...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Form verilerini yönet
        const configData = {
            user_ocid: '',
            tenancy_ocid: '',
            fingerprint: '',
            private_key: '',
            region: 'us-ashburn-1',
            compartment_ocid: '',
            instance_name: 'free-tier-instance',
            shape: 'VM.Standard.E2.1.Micro',
            ocpus: 1,
            memory_gb: 1,
            image_ocid: '',
            subnet_ocid: '',
            availability_domain: '',
            ssh_public_key: '',
            max_attempts: 50,
            retry_interval: 300
        };

        // Sayfa yüklendiğinde çalışacak fonksiyon
        document.addEventListener('DOMContentLoaded', function () {
            // Form elemanlarını yükle
            Object.keys(configData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = configData[key];
                    element.addEventListener('input', () => updateConfig(key, element.value));
                    element.addEventListener('change', () => updateConfig(key, element.value));
                }
            });

            // Shape değişikliğini dinle
            const shapeSelect = document.getElementById('shape');
            shapeSelect.addEventListener('change', handleShapeChange);

            // CPU/RAM değişikliğini dinle
            const cpuRamSelect = document.getElementById('cpu_ram');
            cpuRamSelect.addEventListener('change', handleCpuRamChange);

            // İlk shape kontrolünü yap
            handleShapeChange();

            // Kayıtlı config'i yükle
            loadSavedConfig();

            // Event listener'ları kur
            setupEventListeners();

            // İlk doğrulama
            validateForm();
        });

        // Shape değişikliği
        function handleShapeChange() {
            const shape = document.getElementById('shape').value;
            const cpuRamContainer = document.getElementById('cpu_ram_container');

            configData.shape = shape;

            if (shape === 'VM.Standard.A1.Flex') {
                // A1.Flex seçildi, CPU/RAM seçimini göster
                cpuRamContainer.style.display = 'block';
                handleCpuRamChange(); // Varsayılan CPU/RAM değerlerini ayarla
            } else {
                // E2.1.Micro seçildi, CPU/RAM seçimini gizle
                cpuRamContainer.style.display = 'none';
                configData.ocpus = 1;
                configData.memory_gb = 1;
                document.getElementById('ocpus').value = 1;
                document.getElementById('memory_gb').value = 1;
            }

            validateForm();
        }

        // CPU/RAM değişikliği
        function handleCpuRamChange() {
            const cpuRamValue = document.getElementById('cpu_ram').value;

            // CPU/RAM değerlerini parse et
            const [ocpus, memory] = cpuRamValue.split('_').map(Number);

            configData.ocpus = ocpus;
            configData.memory_gb = memory;
            document.getElementById('ocpus').value = ocpus;
            document.getElementById('memory_gb').value = memory;

            validateForm();
        }

        // Event listener'ları kur
        function setupEventListeners() {
            // Doğrulama butonu
            document.getElementById('validateBtn').addEventListener('click', () => {
                if (validateForm()) {
                    alert('✓ Tüm gerekli alanlar doldurulmuş!');
                } else {
                    alert('✗ Lütfen tüm gerekli alanları doldurun!');
                }
            });

            // Kaydet butonu
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);

            // Başlat butonu
            document.getElementById('startTaskBtn').addEventListener('click', startTask);
        }

        // Config güncelle
        function updateConfig(key, value) {
            configData[key] = value;
            validateForm();
        }

        // Form doğrulama
        function validateForm() {
            const requiredFields = [
                'user_ocid', 'tenancy_ocid', 'compartment_ocid',
                'subnet_ocid', 'availability_domain', 'image_ocid',
                'ssh_public_key', 'fingerprint', 'private_key'
            ];

            let isValid = true;
            requiredFields.forEach(field => {
                if (!configData[field] || configData[field].toString().trim() === '') {
                    isValid = false;
                }
            });

            document.getElementById('startTaskBtn').disabled = !isValid;
            return isValid;
        }

        // Task başlat
        async function startTask() {
            if (!validateForm()) {
                alert('Lütfen tüm gerekli alanları doldurun!');
                return;
            }

            // Shape_config bilgilerini ekle
            const taskData = {
                ...configData,
                shape_config: {
                    ocpus: configData.ocpus,
                    memory_in_gbs: configData.memory_gb
                }
            };

            const modal = new bootstrap.Modal(document.getElementById('startingModal'));
            modal.show();

            try {
                const response = await fetch('/api/start_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });

                const data = await response.json();

                if (data.success) {
                    modal.hide();
                    window.location.href = `/status?task_id=${data.task_id}`;
                } else {
                    modal.hide();
                    alert(`Hata: ${data.error}`);
                }
            } catch (error) {
                modal.hide();
                alert(`Bağlantı hatası: ${error.message}`);
            }
        }

        // Ayarları kaydet
        function saveConfig() {
            localStorage.setItem('oci_config', JSON.stringify(configData));
            alert('Ayarlar tarayıcı belleğine kaydedildi!');
        }

        // Ayarları yükle
        function loadSavedConfig() {
            const saved = localStorage.getItem('oci_config');
            if (saved) {
                try {
                    const savedConfig = JSON.parse(saved);

                    // configData'yı güncelle
                    Object.keys(savedConfig).forEach(key => {
                        if (key in configData) {
                            configData[key] = savedConfig[key];
                        }
                    });

                    // Form elemanlarını güncelle
                    Object.keys(configData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = configData[key];
                        }
                    });

                    // Shape'i tekrar seç
                    if (configData.shape) {
                        document.getElementById('shape').value = configData.shape;
                        handleShapeChange();

                        // Eğer A1.Flex ise CPU/RAM seçimini güncelle
                        if (configData.shape === 'VM.Standard.A1.Flex' && configData.ocpus && configData.memory_gb) {
                            const cpuRamValue = `${configData.ocpus}_${configData.memory_gb}`;
                            const cpuRamSelect = document.getElementById('cpu_ram');
                            cpuRamSelect.value = cpuRamValue;
                        }
                    }

                } catch (e) {
                    console.error('Ayarlar yüklenirken hata:', e);
                }
            }
        }
    </script>
</body>

</html>