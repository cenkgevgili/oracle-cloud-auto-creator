<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Cloud - İşlem Durumu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #1e3a8a);
            min-height: 100vh;
        }

        .glass-card {
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 32px rgba(0, 0, 0, 0.25);
        }

        #messageBox {
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            min-height: 130px;
            background-color: #0b1021;
            color: #d1e8ff;
            border-radius: 10px;
            padding: 12px;
            font-size: 0.92rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container py-4 py-lg-5">
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="text-white mb-1">İşlem Durumu</h1>
                        <small class="text-white-50">Task ID: <span id="taskIdLabel">{{ task_id or '-' }}</span></small>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/" class="btn btn-outline-light">Ana Sayfa</a>
                        <a href="/configure" class="btn btn-light">Yeni Task</a>
                    </div>
                </div>

                <div class="glass-card p-4">
                    <div id="missingTaskAlert" class="alert alert-warning d-none">
                        Task ID bulunamadı. Lütfen önce <a href="/configure" class="alert-link">konfigürasyon</a> sayfasından yeni task başlatın.
                    </div>

                    <div id="statusPanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Canlı İzleme</h5>
                            <span id="statusBadge" class="badge bg-secondary">başlatılıyor</span>
                        </div>

                        <div class="mb-3">
                            <div class="progress" style="height: 20px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                    style="width: 0%">0%</div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Deneme</small>
                                    <strong id="attemptsText">0 / 0</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Shape</small>
                                    <strong id="shapeText">-</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Son Güncelleme</small>
                                    <strong id="lastUpdateText">-</strong>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Mesaj</small>
                            <div id="messageBox">Veri bekleniyor...</div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <button id="stopBtn" class="btn btn-outline-danger">Durdur</button>
                            <button id="refreshBtn" class="btn btn-primary">Yenile</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const taskId = "{{ task_id or '' }}".trim();
        const terminalStates = new Set(["success", "failed", "error", "stopped"]);
        let pollTimer = null;

        const statusBadge = document.getElementById("statusBadge");
        const progressBar = document.getElementById("progressBar");
        const attemptsText = document.getElementById("attemptsText");
        const shapeText = document.getElementById("shapeText");
        const lastUpdateText = document.getElementById("lastUpdateText");
        const messageBox = document.getElementById("messageBox");
        const stopBtn = document.getElementById("stopBtn");
        const refreshBtn = document.getElementById("refreshBtn");
        const missingTaskAlert = document.getElementById("missingTaskAlert");
        const statusPanel = document.getElementById("statusPanel");

        function badgeClassFor(status) {
            if (status === "success") return "bg-success";
            if (status === "failed" || status === "error") return "bg-danger";
            if (status === "stopped") return "bg-dark";
            if (status === "waiting" || status === "retrying") return "bg-warning text-dark";
            if (status === "trying" || status === "checking" || status === "info") return "bg-info text-dark";
            return "bg-secondary";
        }

        function setStatusBadge(status) {
            statusBadge.className = `badge ${badgeClassFor(status)}`;
            statusBadge.textContent = status || "bilinmiyor";
        }

        function updateUI(data) {
            const progress = Number.isFinite(data.progress) ? Math.max(0, Math.min(100, data.progress)) : 0;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            attemptsText.textContent = `${data.attempts || 0} / ${data.max_attempts || 0}`;
            shapeText.textContent = data.shape ? `${data.shape} (${data.ocpus || 1} OCPU / ${data.memory_gb || 1} GB)` : "-";
            lastUpdateText.textContent = data.last_update || "-";
            messageBox.textContent = data.message || "Mesaj yok";
            setStatusBadge(data.status);

            if (terminalStates.has(data.status)) {
                stopPolling();
                stopBtn.disabled = true;
                progressBar.classList.remove("progress-bar-animated");
            } else {
                stopBtn.disabled = false;
                progressBar.classList.add("progress-bar-animated");
            }
        }

        async function fetchStatus() {
            if (!taskId) {
                return;
            }

            try {
                const response = await fetch(`/api/task_status/${taskId}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    messageBox.textContent = data.error || "Durum alınamadı";
                    setStatusBadge("error");
                    stopPolling();
                    return;
                }
                updateUI(data);
            } catch (error) {
                messageBox.textContent = `Bağlantı hatası: ${error.message}`;
                setStatusBadge("error");
                stopPolling();
            }
        }

        function startPolling() {
            stopPolling();
            fetchStatus();
            pollTimer = setInterval(fetchStatus, 2000);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        async function stopTask() {
            if (!taskId) {
                return;
            }
            stopBtn.disabled = true;
            try {
                const response = await fetch(`/api/stop_task/${taskId}`, { method: "POST" });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    stopBtn.disabled = false;
                    alert(data.error || "Task durdurulamadı");
                    return;
                }
                await fetchStatus();
            } catch (error) {
                stopBtn.disabled = false;
                alert(`Durdurma hatası: ${error.message}`);
            }
        }

        stopBtn.addEventListener("click", stopTask);
        refreshBtn.addEventListener("click", fetchStatus);

        if (!taskId) {
            statusPanel.classList.add("d-none");
            missingTaskAlert.classList.remove("d-none");
        } else {
            startPolling();
        }
    </script>
</body>
</html>
